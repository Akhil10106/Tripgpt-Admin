<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripGPT | Sovereign Master Protocol</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

    <style>
        :root { --slate-950: #020617; --indigo-600: #4f46e5; }
        body { background-color: #f8fafc; color: var(--slate-950); font-family: 'Plus Jakarta Sans', sans-serif; height: 100vh; overflow: hidden; margin: 0; }

        /* COMMAND DOCK: Larger Expansion & Right-Side Docking */
        .command-dock {
            position: fixed; bottom: 2rem; 
            left: 50%; transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(25px);
            padding: 0.8rem; border-radius: 4rem; display: none; 
            gap: 1.25rem; box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.5); 
            z-index: 1000; border: 1px solid rgba(255,255,255,0.15);
            /* INCREASED SIZE: Width now scales up to 500px */
            width: min(95vw, 500px); height: 84px; overflow-x: auto; overflow-y: hidden;
            transition: all 0.7s cubic-bezier(0.19, 1, 0.22, 1);
            display: flex; align-items: center; justify-content: flex-start;
            scrollbar-width: none;
        }

        /* Side-dock logic: Shrinks and moves to bottom right */
        .command-dock.collapsed {
            width: 80px;
            height: 80px;
            left: calc(100% - 2rem); 
            transform: translateX(-100%);
            gap: 0;
            padding: 0.6rem;
        }

        .command-dock::-webkit-scrollbar { display: none; }

        .dock-item {
            min-width: 60px; height: 60px; border-radius: 1.8rem; display: flex;
            align-items: center; justify-content: center; color: white; cursor: pointer;
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); flex-shrink: 0; position: relative;
            font-size: 1.25rem;
        }

        .dock-trigger { background: var(--indigo-600); z-index: 20; position: sticky; left: 0; box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3); }

        /* Icon scaling */
        .dock-item:not(.dock-trigger) { opacity: 1; transform: scale(1); }
        .command-dock.collapsed .dock-item:not(.dock-trigger) { opacity: 0; transform: scale(0.3); pointer-events: none; }

        /* Views */
        .view-screen { display: none; position: fixed; inset: 0; background: #f8fafc; z-index: 50; padding: 1.5rem; overflow-y: auto; padding-bottom: 10rem; }
        .view-active { display: block; animation: slideUp 0.4s ease forwards; }
        
        .silk-card { background: white; border-radius: 2.2rem; border: 1px solid rgba(0,0,0,0.08); padding: 2.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.02); transition: 0.3s; }
        .stat-value { font-size: 4.5rem; font-weight: 800; line-height: 1; letter-spacing: -3px; display: block; }
        .stat-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; display: block; margin-bottom: 1rem; }

        .premium-input { border: 2px solid var(--indigo-600) !important; background: #ffffff !important; box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.1); }
        .integrity-ring { width: 12px; height: 12px; border-radius: 50%; background: #10b981; position: relative; }
        .integrity-ring::after { content: ''; position: absolute; inset: -4px; border: 2px solid #10b981; border-radius: 50%; animation: pulse 2s infinite; }
        
        #auth-gate { position: fixed; inset: 0; background: #ffffff; z-index: 3000; display: flex; align-items: center; justify-content: center; }
        .login-box { text-align: center; max-width: 420px; width: 90%; padding: 4rem 2rem; background: white; border-radius: 3.5rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.08); border: 1px solid #f1f5f9; }
        .brand-logo { font-size: 2.5rem; font-weight: 900; letter-spacing: -2px; color: var(--slate-950); margin-bottom: 0.5rem; }
        .brand-accent { color: var(--indigo-600); }
        .btn-auth { width: 100%; background: var(--slate-950); color: white !important; display: flex; align-items: center; justify-content: center; gap: 12px; padding: 18px 0; border-radius: 1.25rem; font-weight: 800; text-transform: uppercase; font-size: 11px; border: none; cursor: pointer;}

        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
    </style>
</head>
<body>

    <div id="auth-gate">
        <div class="login-box">
            <div class="brand-logo">TRIP<span class="brand-accent">GPT</span></div>
            <div class="w-16 h-1 bg-indigo-600 mx-auto mb-10 rounded-full opacity-20"></div>
            <h1 class="text-xl font-black tracking-tighter mb-2 text-slate-900 text-center">Sovereign Master Protocol</h1>
            <button id="admin-login-btn" class="btn-auth">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                <span>Authenticate Admin</span>
            </button>
        </div>
    </div>

    <div id="dock-bar" class="command-dock">
        <div class="dock-item dock-trigger" onclick="toggleDock()"><i class="fa-solid fa-compass"></i></div>
        <div class="dock-item" data-tooltip="Home" onclick="showView('v-home')"><i class="fa-solid fa-house-chimney-window"></i></div>
        <div class="dock-item" data-tooltip="Users" onclick="showView('v-users')"><i class="fa-solid fa-user-shield"></i></div>
        <div class="dock-item" data-tooltip="Circles" onclick="showView('v-groups')"><i class="fa-solid fa-circle-nodes"></i></div>
        <div class="dock-item" data-tooltip="Idle" onclick="showView('v-inactive')"><i class="fa-solid fa-moon"></i></div>
        <div class="dock-item" data-tooltip="Pulse" onclick="showView('v-announce')"><i class="fa-solid fa-bullhorn"></i></div>
        <div class="dock-item bg-red-500/20 text-red-400" onclick="logout()"><i class="fa-solid fa-power-off"></i></div>
    </div>

    <div id="v-home" class="view-screen view-active">
        <div class="max-w-6xl mx-auto py-10">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-16 gap-6">
                <div>
                    <h2 class="text-6xl font-black tracking-tighter text-gray-900">System <span class="text-indigo-600">Overview.</span></h2>
                    <p class="text-gray-500 font-bold mt-2 text-xl">Authorized Administrative Protocol.</p>
                </div>
                <div class="flex items-center gap-3 bg-white px-6 py-3 rounded-full border border-slate-100 shadow-sm">
                    <div class="integrity-ring"></div>
                    <span class="text-[10px] font-black uppercase tracking-widest text-gray-800">Cloud Integrity: Optimal</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
                <div class="silk-card bg-indigo-600 border-none shadow-2xl">
                    <span class="stat-label text-indigo-100 opacity-70">Network Reach</span>
                    <span class="stat-value text-white" id="home-stat-groups">0</span>
                    <p class="text-sm font-bold text-white mt-4">Active User Circles</p>
                </div>
                <div class="silk-card bg-white border-2 border-slate-50">
                    <span class="stat-label text-slate-400">Global Population</span>
                    <span class="stat-value text-gray-900" id="home-stat-accounts">0</span>
                    <p class="text-sm font-bold text-indigo-600 mt-4">Verified Master Accounts</p>
                </div>
                <div class="silk-card bg-white border-2 border-slate-50">
                    <span class="stat-label text-slate-400">Data Persistence</span>
                    <span class="stat-value text-gray-900" id="home-stat-tx">0</span>
                    <p class="text-sm font-bold text-indigo-600 mt-4">Historical Records</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="silk-card bg-white border-2 border-slate-50">
                    <h4 class="font-black text-2xl mb-8 tracking-tight text-gray-900"><i class="fa-solid fa-bolt text-amber-500 mr-2"></i> System Activity</h4>
                    <div class="flex items-center gap-5 p-6 bg-slate-50 rounded-3xl">
                        <div class="w-3 h-3 bg-indigo-600 rounded-full animate-pulse"></div>
                        <p class="text-base font-bold text-gray-700">Real-time Node Monitoring Active</p>
                        <span class="ml-auto text-[10px] font-black text-indigo-600 uppercase">Syncing</span>
                    </div>
                </div>
                <div class="silk-card bg-gray-900 text-white border-none relative overflow-hidden">
                    <div class="relative z-10">
                        <h4 class="font-black text-2xl mb-4 tracking-tight">Sovereign Command</h4>
                        <p class="text-base font-medium opacity-60 mb-10 leading-relaxed text-left">Click the Compass button to move navigation to the side or expand it to full width.</p>
                        <button onclick="toggleDock()" class="bg-indigo-600 text-white px-10 py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl border-none cursor-pointer">Toggle System Hub</button>
                    </div>
                    <i class="fa-solid fa-crown absolute -right-6 -bottom-6 text-9xl opacity-5 rotate-12"></i>
                </div>
            </div>
        </div>
    </div>

    <div id="v-users" class="view-screen"><div class="max-w-7xl mx-auto"><h2 class="text-5xl font-black tracking-tighter mb-12">Global <span class="text-indigo-600">Accounts</span></h2><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="user-list-grid"></div></div></div>
    <div id="v-groups" class="view-screen"><div class="max-w-5xl mx-auto"><h2 class="text-5xl font-black tracking-tighter mb-12">Network <span class="text-indigo-600">Index</span></h2><div class="space-y-4" id="group-list-container"></div></div></div>
    <div id="v-inactive" class="view-screen"><div class="max-w-5xl mx-auto"><div class="flex flex-col sm:flex-row justify-between items-end mb-12 gap-4"><h2 class="text-5xl font-black tracking-tighter">Idle <span class="text-indigo-600">Nodes</span></h2><button onclick="purgeAllInactive()" class="bg-red-50 text-red-500 px-6 py-3 rounded-2xl font-black text-[10px] uppercase border border-red-100">Purge All Inactive</button></div><div class="space-y-4" id="inactive-list"></div></div></div>
    <div id="v-announce" class="view-screen"><div class="max-w-3xl mx-auto"><h2 class="text-5xl font-black tracking-tighter mb-12">System <span class="text-indigo-600">Pulse</span></h2><div class="silk-card shadow-2xl"><div class="mb-8"><label class="stat-label text-slate-400 mb-3 block">Message Payload</label><textarea id="ann-text" class="w-full premium-input p-6 rounded-3xl h-40 font-bold outline-none" placeholder="Enter administrative message..."></textarea></div><div class="mb-8"><div class="flex justify-between items-center mb-4"><label class="stat-label text-slate-400">Target Nodes</label><button onclick="selectAllGroups()" class="text-[10px] font-black text-indigo-600 underline">Select All</button></div><div id="ann-group-selector" class="flex flex-wrap gap-2 max-h-48 overflow-y-auto p-4 bg-slate-50 rounded-3xl"></div></div><button onclick="deployAnnouncement()" class="w-full bg-indigo-600 text-white py-6 rounded-3xl font-black uppercase tracking-widest shadow-xl">Execute Pulse Broadcast</button></div></div></div>

    <div id="group-popup"><div class="bg-white p-12 rounded-[3.5rem] max-w-md w-full relative text-center shadow-2xl"><button onclick="closePopup()" class="absolute top-10 right-10 text-slate-300 hover:text-slate-900"><i class="fa-solid fa-xmark text-xl"></i></button><div id="popup-content"></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCpLtdJ4lACW9pNn8fAUmooooqzh_5TIO4", authDomain: "trip-ddc48.firebaseapp.com", databaseURL: "https://trip-ddc48-default-rtdb.firebaseio.com", projectId: "trip-ddc48" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const MASTER_ID = "akhilgoel985@gmail.com";
        let dormantIds = [];

        auth.onAuthStateChanged(user => {
            if (user && user.email.toLowerCase() === MASTER_ID) {
                document.getElementById('auth-gate').style.display = 'none';
                document.getElementById('dock-bar').style.display = 'flex';
                syncData();
            } else if (user) { auth.signOut(); }
        });

        function toggleDock() { document.getElementById('dock-bar').classList.toggle('collapsed'); }

        function showView(id) { 
            document.querySelectorAll('.view-screen').forEach(v => v.classList.remove('view-active')); 
            document.getElementById(id).classList.add('view-active');
        }

        function syncData() {
            db.ref('groups').on('value', snap => {
                const groups = snap.val() || {};
                const userGrid = document.getElementById('user-list-grid');
                const groupList = document.getElementById('group-list-container');
                const inactiveList = document.getElementById('inactive-list');
                const selector = document.getElementById('ann-group-selector');

                userGrid.innerHTML = ''; groupList.innerHTML = ''; inactiveList.innerHTML = ''; selector.innerHTML = '';
                let users = {}; let groupArr = []; dormantIds = []; let totalTx = 0;

                Object.entries(groups).forEach(([id, g]) => {
                    const members = g.members || [];
                    const expenses = g.expenses ? Object.keys(g.expenses).length : 0;
                    totalTx += expenses;
                    groupArr.push({ id, ...g, memberCount: members.length });
                    selector.innerHTML += `<div class="chip bg-white border border-slate-200 px-5 py-2.5 rounded-2xl text-[10px] font-black cursor-pointer hover:border-indigo-600 transition-all" onclick="this.classList.toggle('bg-indigo-600'); this.classList.toggle('text-white');" data-id="${id}">${g.name}</div>`;
                    members.forEach(m => { if(!users[m.email]) users[m.email] = { name: m.name, email: m.email }; });
                    if(members.length < 2 || !g.expenses) {
                        dormantIds.push(id);
                        inactiveList.innerHTML += `<div class="silk-card flex justify-between items-center mb-4 p-6"><div class="flex items-center gap-4"><div class="w-3 h-3 bg-red-400 rounded-full"></div><div><p class="font-black text-gray-800">${g.name}</p><p class="text-[9px] text-slate-300 font-black uppercase">${id}</p></div></div><button onclick="deleteGroup('${id}', '${g.name}')" class="text-red-300 hover:text-red-500 p-2 bg-transparent border-none cursor-pointer"><i class="fa-solid fa-trash-can"></i></button></div>`;
                    }
                });

                document.getElementById('home-stat-groups').innerText = Object.keys(groups).length;
                document.getElementById('home-stat-accounts').innerText = Object.keys(users).length;
                document.getElementById('home-stat-tx').innerText = totalTx;

                Object.values(users).forEach(u => {
                    userGrid.innerHTML += `<div class="silk-card flex flex-col items-center text-center"><div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-3xl flex items-center justify-center mb-5 font-black text-2xl shadow-inner">${u.name.charAt(0)}</div><h4 class="font-black text-slate-900 text-lg">${u.name}</h4><p class="text-xs font-bold text-slate-400 mb-6">${u.email}</p><div class="w-full pt-4 border-t border-slate-50"><span class="bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest">Master Member</span></div></div>`;
                });
                groupArr.sort((a,b) => b.memberCount - a.memberCount).forEach((g, i) => {
                    groupList.innerHTML += `<div class="silk-card flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-all mb-4" onclick="openPopup('${g.id}')"><div class="flex items-center gap-6"><div class="text-3xl">${i === 0 ? 'üèÜ' : 'üìÅ'}</div><div><p class="font-black text-xl text-slate-900">${g.name}</p><p class="text-[10px] font-black text-slate-300 uppercase">${g.id}</p></div></div><div class="text-right"><p class="text-3xl font-black text-indigo-600 leading-none">${g.memberCount}</p><p class="text-[9px] font-black uppercase text-slate-400 mt-2">Active Users</p></div></div>`;
                });
            });
        }

        async function openPopup(id) {
            const snap = await db.ref(`groups/${id}`).get();
            const g = snap.val();
            const members = g.members || [];
            document.getElementById('popup-content').innerHTML = `<div class="w-24 h-24 bg-indigo-50 text-indigo-600 rounded-[2rem] flex items-center justify-center mx-auto mb-8 shadow-inner"><i class="fa-solid fa-circle-nodes text-4xl"></i></div><h3 class="text-3xl font-black tracking-tighter mb-1 text-slate-900">${g.name}</h3><p class="text-indigo-600 font-bold mb-10 text-[10px] uppercase tracking-widest">${id}</p><div class="space-y-4 text-left"><div class="bg-slate-50 p-6 rounded-3xl flex justify-between items-center"><span class="text-[9px] font-black uppercase text-slate-400">Population</span><span class="font-black text-slate-900">${members.length} Users</span></div><div class="bg-slate-50 p-6 rounded-3xl flex justify-between items-center"><span class="text-[9px] font-black uppercase text-slate-400">Admin</span><span class="font-black text-slate-900 text-xs">${g.admin}</span></div></div>`;
            document.getElementById('group-popup').style.display = 'flex';
        }

        async function deployAnnouncement() {
            const msg = document.getElementById('ann-text').value.trim();
            const selected = Array.from(document.querySelectorAll('#ann-group-selector .bg-indigo-600')).map(el => el.dataset.id);
            if(!msg || selected.length === 0) return alert("Required: Message & Targets.");
            const updates = {};
            selected.forEach(groupId => {
                const annKey = db.ref(`groups/${groupId}/announcements`).push().key;
                updates[`groups/${groupId}/announcements/${annKey}`] = { message: msg, timestamp: new Date().getTime() };
                const logKey = db.ref(`groups/${groupId}/expenses`).push().key;
                updates[`groups/${groupId}/expenses/${logKey}`] = { title: "üì¢ ADMIN: " + msg, amount: 0, involved: ["SYSTEM"], by: "ADMIN", date: new Date().toLocaleDateString() };
            });
            await db.ref().update(updates);
            alert("Broadcast Success."); document.getElementById('ann-text').value = '';
        }

        async function purgeAllInactive() { if(dormantIds.length === 0) return; if(confirm(`Purge all ${dormantIds.length} dormant nodes?`)) { for(const id of dormantIds) { await db.ref(`groups/${id}`).remove(); } alert("Cloud Cleanse."); } }
        async function deleteGroup(id, name) { if(confirm(`Purge "${name}"?`)) await db.ref(`groups/${id}`).remove(); }
        function selectAllGroups() { document.querySelectorAll('#ann-group-selector .chip').forEach(el => el.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600')); }
        function closePopup() { document.getElementById('group-popup').style.display = 'none'; }
        function logout() { auth.signOut().then(() => location.reload()); }
        document.getElementById('admin-login-btn').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    </script>
</body>
</html>
